<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    </head>
    <body>
        <div class="container-fluid">
            <div class="row mt-4">
            <div class="col-12">
                <h3>Ranger AI</h3>
            </div>
            </div>

            <div class="mt-3 mb-5">
            <div class="input-group mb-3">
                <input list="recentPrompts" type="text" id="searchInput" class="form-control" placeholder="Ask Ranger AI something...">
                <datalist id="recentPrompts"></datalist>
                <button class="btn btn-primary" type="button" onclick="submitPrompt()">Send</button>
            </div>
            <pre id="responseBox" class="bg-light p-3 border rounded" style="white-space: pre-wrap; word-break: break-word;"></pre>
            <div>
                <small id="timerDisplay" class="text-muted mt-2 d-block"></small>
            </div>
            </div>
        </div>

        <script>
        const MAX_HISTORY = 50;
        const STORAGE_KEY = "rangerai_prompt_history";

        function loadPromptHistory() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
            "What are the names of the current machines?",
            "What are the IP addresses of the current machines?",
            "What is the IP of the machine that starts with the letter v?",
            "What firmware are the machines running?",
            "What are the current ips used by the machines?"
            ];

            const datalist = document.getElementById("recentPrompts");
            datalist.innerHTML = "";
            history.forEach(item => {
            const option = document.createElement("option");
            option.value = item;
            datalist.appendChild(option);
            });
        }

        function savePrompt(prompt) {
            if (!prompt || !prompt.trim()) return;

            let history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            history = history.filter(p => p !== prompt); // deduplicate
            history.unshift(prompt); // add to front
            if (history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        async function submitPrompt() {
            const prompt = document.getElementById("searchInput").value;
            const responseBox = document.getElementById("responseBox");
            const timerDisplay = document.getElementById("timerDisplay");
            responseBox.textContent = "Loading...";
            timerDisplay.textContent = "";

            savePrompt(prompt);
            loadPromptHistory();

            const startTime = performance.now();

            try {
            const res = await fetch(`http://localhost:5678/webhook/`, {
                method: "POST",
                headers: {
                "Content-Type": "application/json"
                },
                body: JSON.stringify({ prompt: prompt })
            });

            const data = await res.json();
            const endTime = performance.now();

            console.log(data);

            responseBox.textContent = data.response || "(No response)";
            const duration = endTime - startTime;
            if (duration < 1000) {
                timerDisplay.textContent = `⏱️ Responded in ${duration.toFixed(0)} ms`;
            } else {
                timerDisplay.textContent = `⏱️ Responded in ${(duration / 1000).toFixed(2)} seconds`;
            }
            } catch (err) {
            console.error("Error:", err);
            responseBox.textContent = "Failed to reach Ranger AI. Is it configured correctly?";
            }
        }

        document.getElementById("searchInput").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
            event.preventDefault();
            submitPrompt();
            }
        });

        window.onload = () => {
            loadPromptHistory();
            document.getElementById("searchInput").focus();
        };

        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    </body>
</html>
